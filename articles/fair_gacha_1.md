> 新しい手法を開発しました。
> [僕が（ほとんどを考えた）公平なガチャシステム](http://qiita.com/yyu/items/90db09c57514758bd68c)

# はじめに

ソーシャルゲームのガチャは、あらかじめ運営からSSRなどのレアリティに基づいた出現確率が公表されているが、それはあくまで運営が公表した値でしかなく、本当にその通りなのか疑う余地があった。そこでこの記事では[前回の記事](http://qiita.com/yyu/items/c342c3c90ac78f26d5e1)で紹介したハッシュの衝突に基いて、ユーザーにとっても運営にとってもガチャによるカードの出現確率が明らかな方法を提案する。何か質問や意見などがあれば、気軽にコメントして欲しい。

# プロトコル

この計算量を利用した方法はどこかのCTFで出題されたと友人から聞いて、それを使っている。

## 日本語による手順

1. 運営はカードとそれに対応する**マスク**を公開する。このマスクは$n$ビットで構成されていて、カードの種類と一対一に対応している。このマスクはSSRなど希少なカードほど1のビットが多く、Nなどありがちなカードほど0が多くなるようにしておく。
2. ユーザーがガチャを引こうとすると、アプリケーションがサーバーへそのことを通知する
3. サーバーは、無作為な文字列**A**と$n$ビットのデータ**B**をデータベースへ書き込み、**A**と**B**をアプリケーションへ送信する
4. アプリケーションは**A**に任意の文字列を追加して、文字列**C**を生成する
5. アプリケーションは文字列**C**のハッシュ値を計算し、**B**とのAND（論理積）を計算し、それを**D**とする
    - $D = B\, \\&\, hash(C)$
6. アプリケーションは**D**に対応する**マスク**を持つカードを表示し、**A**と**B**と**C**をサーバーへ送信する
    - もし**D**に対応する**マスク**が一つもない場合は（4）からやりなおす
7. サーバーは次のことを検証する
    - サーバー側のデータベースに**A**と**B**が記録されているか
    - 文字列**C**の中に**A**が含まれているか
7. サーバーは**C**からアプリケーションと同じように**D**を計算する
    - $D = B\, \\&\, hash(C)$
8. サーバーは**D**と同じ**マスク**を持つカードをユーザーに与える
    - もし**D**に対応する**マスク**が一つもない場合はエラーを返す
9. データベースから**A**と**B**を削除

## シーケンス図

https://gist.github.com/yoshimuraYuu/95b4d8134e283ddeb920
![diagram-4885526936437794416.png](https://qiita-image-store.s3.amazonaws.com/0/10815/ec9bb04b-495a-36f2-27a2-09f4e32b76e3.png)

# レアリティの操作

ソーシャルゲームの多くはレアリティがSSRだと1%、Nだと50%などと決められている。このような確率を表現する手段として、**マスク**の立っているビットの量を使う。例えば**マスク**で立っているビット数が1つであれば、ユーザーにとって**C**を求めるのが容易になるし、一方で$n$に近い数であれば**C**を求めるのは困難になる。このように、ハッシュ値を計算する試行回数を利用して、レアリティを操作することができる。

# 公平性

これのポイントは、ガチャを**サーバーが生成した（と思われる）乱数**から**ハッシュ値の衝突確率**という問題に切り替えたことだと思う。こうすることで、不透明なサーバー内でのガチャ処理を行わずに、透明なハッシュ値によるガチャを行うことができる。ユーザーは、サーバーにデータを送る前に自分が引いたガチャの結果を知ることができるし、もしサーバーで検証して自分で確かめた結果と異なる場合は、どちらが悪いのか確かめることができる。
また、これは計算の直前に**A**を与えている。これがソルトのような役割を果すので、あらかじめ大量に計算するのは無駄と思われる。

# 課金

ユーザーが課金した場合、多くのゲームは無課金のガチャに比べてレアカードの出現率が高くなる。このような処理は、ユーザーのIDに課金情報を持っておいて、課金状態やガチャの種類によって**マスク**の一覧を変えればいい。ただし、これら**マスク**は全てユーザーに公開されている必要がある。

# データ**C**の販売

業者などが介入した場合、業者は**A**と**B**を入手した後、ハッシュ値を求めるための高性能なコンピューターやハードウェアを用いて、高速に**C**を計算し、それをオークションなどで売りさばく可能性がある。これを防ぐためには次の手順を実行すればよい。

1. **A**と**B**をサーバーが発行する際に、データベースへユーザー情報を保存する
2. アプリケーションが**C**を送る際、ユーザー情報をともに送信する
3. サーバーはデータベースからユーザー情報を取得し、それと送信されたユーザー情報を検証する
